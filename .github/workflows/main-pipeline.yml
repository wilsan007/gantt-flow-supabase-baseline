name: CI/CD Pipeline - Test & Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Quality Checks
  quality-checks:
    name: üîç Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: üîç ESLint
        run: npm run lint
        continue-on-error: false
      
      - name: üíÖ Prettier
        run: npm run format:check
        continue-on-error: false
      
      - name: üìù TypeScript
        run: npm run type-check
        continue-on-error: false

  # Job 2: Tests
  tests:
    name: üß™ Tests
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: üß™ Run Tests
        run: npm run test -- --run
        continue-on-error: false

  # Job 3: Build
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üßπ Clean Previous Build
        run: |
          rm -rf dist/
          rm -rf node_modules/.vite
          echo "‚úÖ Nettoyage termin√©"
      
      - name: üì¶ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: üèóÔ∏è Build Application
        run: npm run build
        env:
          NODE_ENV: production
          CI: false
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      
      - name: üìä Build Info & Verification
        run: |
          echo "## ‚úÖ Build Successful" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist" ]; then
            BUILD_SIZE=$(du -sh dist | cut -f1)
            BUILD_SIZE_KB=$(du -sk dist | cut -f1)
            FILE_COUNT=$(find dist -type f | wc -l)
            JS_COUNT=$(find dist/assets -name "*.js" 2>/dev/null | wc -l)
            CSS_COUNT=$(find dist/assets -name "*.css" 2>/dev/null | wc -l)
            
            echo "üìä BUILD ANALYSIS"
            echo "üì¶ **Size:** $BUILD_SIZE ($BUILD_SIZE_KB KB)" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ **Total Files:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "üìú **JS Files:** $JS_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "üé® **CSS Files:** $CSS_COUNT" >> $GITHUB_STEP_SUMMARY
            
            # Logs d√©taill√©s
            echo ""
            echo "üìÇ dist/ structure:"
            ls -lah dist/
            echo ""
            echo "üìÇ dist/assets/ contents:"
            if [ -d "dist/assets" ]; then
              ls -lah dist/assets/ | head -20
              echo ""
              echo "Total assets size:"
              du -sh dist/assets/
            else
              echo "‚ùå dist/assets/ N'EXISTE PAS!"
            fi
            
            # V√©rification taille minimale (doit √™tre > 2000 KB)
            if [ $BUILD_SIZE_KB -lt 2000 ]; then
              echo "‚ùå ERREUR: Build trop petit ($BUILD_SIZE_KB KB < 2000 KB)"
              echo "Le build est incomplet!"
              echo ""
              echo "üîç V√©rification package.json build script..."
              cat package.json | grep -A5 "\"build\""
              exit 1
            fi
            
            echo "‚úÖ Build de taille correcte: $BUILD_SIZE_KB KB"
          else
            echo "‚ùå ERREUR: Dossier dist/ inexistant"
            exit 1
          fi
      
      - name: üìã Pre-Upload Verification
        run: |
          echo "üîç V√©rification avant upload artifact..."
          echo ""
          echo "üìä Fichiers qui seront upload√©s:"
          find dist -type f -exec ls -lh {} \; | awk '{print $5, $9}' | sort -hr | head -20
          echo ""
          echo "üì¶ Les 10 plus gros fichiers JS:"
          find dist/assets -name "*.js" -exec ls -lh {} \; 2>/dev/null | awk '{print $5, $9}' | sort -hr | head -10
          echo ""
          echo "üíæ Taille totale qui DEVRAIT √™tre upload√©e:"
          du -sh dist/
      
      - name: üì§ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7
          compression-level: 0  # D√©sactiver compression pour tester
          include-hidden-files: true

  # Job 4: Deploy to LWS (SEULEMENT si tous les tests passent)
  deploy:
    name: üöÄ Deploy to LWS
    runs-on: ubuntu-latest
    needs: build
    if: success()
    environment:
      name: production
      url: https://wadashaqayn.com
    
    steps:
      - name: üì• Download Build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/
      
      - name: üìã List Files
        run: |
          echo "üìÅ Fichiers √† d√©ployer:"
          ls -lah dist/
      
      - name: üöÄ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21
          protocol: ftp
          security: loose
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          dangerous-clean-slate: true
      
      - name: ‚úÖ Deployment Summary
        run: |
          echo "## üéâ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Build:** Successful" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Deploy:** Completed" >> $GITHUB_STEP_SUMMARY
          echo "üåê **Server:** LWS" >> $GITHUB_STEP_SUMMARY
          echo "üåê **URL:** https://wadashaqayn.com" >> $GITHUB_STEP_SUMMARY
          echo "üìÖ **Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó Votre site est maintenant √† jour sur LWS!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Statistiques" >> $GITHUB_STEP_SUMMARY
          echo "- Supabase: ‚úÖ Connect√©" >> $GITHUB_STEP_SUMMARY
          echo "- Domaine: wadashaqayn.com" >> $GITHUB_STEP_SUMMARY
          echo "- H√©bergeur: LWS" >> $GITHUB_STEP_SUMMARY

  # Job 5: Notification si √©chec
  notify-failure:
    name: ‚ùå Failure Notification
    runs-on: ubuntu-latest
    needs: [quality-checks, tests, build, deploy]
    if: failure()
    
    steps:
      - name: ‚ùå Failed Stage
        run: |
          echo "## ‚ùå Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Le d√©ploiement n'a pas eu lieu car une √©tape a √©chou√©." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### V√©rifiez:" >> $GITHUB_STEP_SUMMARY
          echo "- Les tests unitaires" >> $GITHUB_STEP_SUMMARY
          echo "- Les erreurs ESLint" >> $GITHUB_STEP_SUMMARY
          echo "- Les erreurs de build" >> $GITHUB_STEP_SUMMARY
