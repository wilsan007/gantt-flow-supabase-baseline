================================================================================
üîß FIX: METTRE √Ä JOUR HANDLE-EMAIL-CONFIRMATION
================================================================================

Pour r√©soudre d√©finitivement le probl√®me "Aucun r√¥le assign√©",
modifier la Edge Function handle-email-confirmation.

================================================================================
üìç MODIFICATION √Ä APPORTER
================================================================================

Fichier: supabase/functions/handle-email-confirmation/index.ts
Ligne: ~1195 (apr√®s la cr√©ation du profil)

AJOUTER CE CODE APR√àS LA CR√âATION DU PROFIL:

```typescript
// Mettre √† jour les m√©tadonn√©es utilisateur avec tenant_id
// CRITIQUE: Sans cela, les RLS policies ne peuvent pas valider l'acc√®s
console.log('');
console.log('üîÑ √âTAPE 10: Mise √† jour m√©tadonn√©es JWT avec tenant_id...');
console.log('   - User ID:', user.id);
console.log('   - Tenant ID √† ajouter:', invitation.tenant_id);
console.log('   - R√¥le √† ajouter: tenant_admin');

const metadataStart = Date.now();
const { data: updatedUser, error: metadataError } = await supabaseAdmin.auth.admin.updateUserById(
  user.id,
  {
    user_metadata: {
      ...user.raw_user_meta_data,
      tenant_id: invitation.tenant_id,
      role: 'tenant_admin',
      tenant_name: validatedCompanyName,
      onboarding_completed: false
    },
    app_metadata: {
      tenant_id: invitation.tenant_id,
      role: 'tenant_admin'
    }
  }
);
const metadataEnd = Date.now();

console.log('   - Dur√©e mise √† jour:', (metadataEnd - metadataStart), 'ms');

if (metadataError) {
  console.error('');
  console.error('‚ö†Ô∏è AVERTISSEMENT: Erreur mise √† jour m√©tadonn√©es');
  console.error('   - Code erreur:', metadataError.code || 'NON D√âFINI');
  console.error('   - Message:', metadataError.message || 'NON D√âFINI');
  console.error('   - Impact: L\'utilisateur devra peut-√™tre se reconnecter');
  console.error('   - Non critique: Le processus continue');
  console.error('');
} else {
  console.log('');
  console.log('‚úÖ √âTAPE 10 R√âUSSIE: M√©tadonn√©es JWT mises √† jour!');
  console.log('   - tenant_id ajout√©: OUI');
  console.log('   - role ajout√©: tenant_admin');
  console.log('   - tenant_name ajout√©:', validatedCompanyName);
  console.log('   - Les RLS policies pourront maintenant valider l\'acc√®s');
  console.log('');
}
```

================================================================================
üìç EMPLACEMENT EXACT
================================================================================

Ins√©rer APR√àS cette section (ligne ~1195):

```typescript
// 5. Cr√©er le profil utilisateur
console.log('üìã Cr√©ation du profil...');
const { error: profileError } = await supabaseAdmin.from('profiles').upsert({
  user_id: user.id,
  tenant_id: invitation.tenant_id,
  full_name: invitation.full_name,
  email: user.email,
  role: 'tenant_admin',
  updated_at: new Date().toISOString()
}, {
  onConflict: 'user_id'
});
if (profileError) {
  console.error('‚ùå Erreur cr√©ation profil:', profileError);
  throw new Error(`Erreur cr√©ation profil: ${profileError.message}`);
}
console.log('‚úÖ Profil cr√©√©');

// ‚Üê ‚Üê ‚Üê INS√âRER LE NOUVEAU CODE ICI ‚Üê ‚Üê ‚Üê

// 6. G√©n√©rer un employee_id unique
console.log('üî¢ G√©n√©ration employee_id...');
```

================================================================================
üéØ POURQUOI CETTE MODIFICATION?
================================================================================

1. **RLS Policies d√©pendent du tenant_id dans le JWT**
   - Les policies sur user_roles v√©rifient probablement le tenant_id
   - Sans tenant_id dans user_metadata/app_metadata, la policy bloque

2. **Le JWT est cr√©√© √† partir des m√©tadonn√©es utilisateur**
   - user_metadata ‚Üí Accessible c√¥t√© client
   - app_metadata ‚Üí Seulement c√¥t√© serveur (plus s√©curis√©)
   - Les deux sont inclus dans le JWT

3. **Sans cette mise √† jour:**
   - L'utilisateur n'a pas tenant_id dans son JWT
   - Les requ√™tes vers user_roles sont bloqu√©es par RLS
   - useUserRoles retourne userRoles = []
   - canAccessTasks = false
   - ‚Üí "Acc√®s refus√©"

4. **Avec cette mise √† jour:**
   - L'utilisateur a tenant_id dans son JWT
   - Les RLS policies reconnaissent l'utilisateur comme membre du tenant
   - useUserRoles retourne les r√¥les correctement
   - canAccessTasks = true
   - ‚Üí Acc√®s autoris√© ‚úÖ

================================================================================
üß™ TESTER LE FIX
================================================================================

1. **D√©ployer la modification:**
   ```bash
   supabase functions deploy handle-email-confirmation
   ```

2. **Tester avec un nouvel utilisateur:**
   - Envoyer une nouvelle invitation depuis le Super Admin
   - L'utilisateur clique sur le lien d'invitation
   - V√©rifier qu'il arrive directement sur le dashboard
   - Plus de message "Aucun r√¥le assign√©"

3. **Corriger les utilisateurs existants:**
   - Ex√©cuter le script SQL dans DIAGNOSTIC_ROLES_MANQUANTS.txt
   - Solution 3: Mise √† jour manuelle des m√©tadonn√©es
   - Demander aux utilisateurs de se d√©connecter/reconnecter

================================================================================
üì¶ CHANGEMENTS DANS AUTRES FICHIERS (OPTIONNEL)
================================================================================

Si vous voulez aussi am√©liorer le feedback utilisateur:

**Fichier: src/pages/PermissionsErrorPage.tsx**

Ajouter un message plus utile:

```typescript
<CardDescription className="text-muted-foreground">
  {errorCode === 'no_role_assigned' && (
    <>
      Vous n'avez pas encore de r√¥le assign√©. Cela peut arriver si:
      <ul className="mt-2 space-y-1 list-disc list-inside">
        <li>Votre compte vient d'√™tre cr√©√© (veuillez patienter 1-2 minutes)</li>
        <li>Vous devez vous d√©connecter et vous reconnecter</li>
        <li>Un administrateur doit vous assigner un r√¥le</li>
      </ul>
      
      <Button 
        onClick={() => {
          supabase.auth.signOut();
          window.location.href = '/auth';
        }}
        className="mt-4"
        variant="outline"
      >
        Se d√©connecter et r√©essayer
      </Button>
    </>
  )}
</CardDescription>
```

================================================================================
‚úÖ CHECKLIST APR√àS MODIFICATION
================================================================================

- [ ] Code ajout√© dans handle-email-confirmation
- [ ] Edge Function red√©ploy√©e
- [ ] Test avec nouvelle invitation
- [ ] Utilisateur arrive sur dashboard sans erreur
- [ ] V√©rification logs Supabase (m√©tadonn√©es bien mises √† jour)
- [ ] Correction des utilisateurs existants (si n√©cessaire)
- [ ] Documentation mise √† jour

================================================================================
