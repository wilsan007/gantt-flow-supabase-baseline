name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Tests et Build
  test-and-build:
    name: ğŸ§ª Tests & Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      # si tu n'as pas encore de tests, tu peux laisser comme Ã§a
      - name: ğŸ§ª Run Tests
        run: npm run test -- --run
        continue-on-error: true

      # on garde le lint mais on ne bloque pas le pipeline
      - name: ğŸ” ESLint Check
        run: npm run lint || echo "::warning::ESLint warnings found"

      - name: ğŸ—ï¸ Build Application
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“Š Build Summary
        run: |
          echo "## ğŸ‰ Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          if [ -d "dist" ]; then
            BUILD_SIZE=$(du -sh dist | cut -f1)
            echo "**Build Size:** $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7

  # Job 2: DÃ©ploiement vers Hostinger
  deploy-hostinger:
    name: ğŸš€ Deploy to Hostinger
    needs: test-and-build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/

      - name: ğŸ“‹ List Build Files
        run: |
          echo "ğŸ“ Fichiers Ã  dÃ©ployer:"
          ls -lah dist/

      - name: ğŸš€ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
          dangerous-clean-slate: false

      - name: âœ… Deployment Summary
        run: |
          echo "## ğŸ‰ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production (Hostinger)" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed At:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://votre-domaine.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [Visiter le site](https://votre-domaine.com)" >> $GITHUB_STEP_SUMMARY

  # Job 3: Notification de succÃ¨s
  notify-success:
    name: ğŸ“¢ Notification
    needs: deploy-hostinger
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ‰ Success Message
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi sur Hostinger!"
          echo "ğŸŒ Votre application est maintenant en ligne"
