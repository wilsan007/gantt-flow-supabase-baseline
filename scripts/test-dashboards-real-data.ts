/**
 * Script de Test - Dashboards avec Donn√©es R√©elles
 * Test complet des dashboards Projets/T√¢ches et RH avec donn√©es DB
 */

import { config } from 'dotenv';
import { createClient } from '@supabase/supabase-js';
import { exportToCSV, formatDateForExport, formatCurrencyForExport } from '../src/lib/exportUtils';
import { exportTableToPDF, exportHybridPDF } from '../src/lib/pdfExportUtils';
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Charger les variables d'environnement
config({ path: path.join(__dirname, '../.env') });

// Configuration Supabase
const SUPABASE_URL = process.env.VITE_SUPABASE_URL || 'https://qliinxtanjdnwxlvnxji.supabase.co';
const SUPABASE_ANON_KEY = process.env.VITE_SUPABASE_ANON_KEY || '';

if (!SUPABASE_ANON_KEY) {
  console.error('‚ùå ERREUR: VITE_SUPABASE_ANON_KEY manquant dans .env');
  console.log('\nüí° Cr√©ez un fichier .env avec:');
  console.log('VITE_SUPABASE_URL=https://qliinxtanjdnwxlvnxji.supabase.co');
  console.log('VITE_SUPABASE_ANON_KEY=votre_cle_anon\n');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Dossier de sortie pour les tests
const OUTPUT_DIR = path.join(__dirname, '../test-outputs');

// Cr√©er le dossier s'il n'existe pas
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

// =====================================================
// 1. TEST DASHBOARD PROJETS
// =====================================================

async function testProjectsDashboard() {
  console.log('\nüìä TEST DASHBOARD PROJETS\n' + '='.repeat(50));

  try {
    // R√©cup√©rer les projets r√©els
    const { data: projects, error } = await supabase
      .from('projects')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) throw error;

    console.log(`‚úÖ ${projects?.length || 0} projets r√©cup√©r√©s de la DB`);

    if (!projects || projects.length === 0) {
      console.log('‚ö†Ô∏è  Aucun projet trouv√© - Test avec donn√©es mock√©es');
      return testWithMockProjects();
    }

    // Calculer les m√©triques
    const totalProjects = projects.length;
    const activeProjects = projects.filter(p => p.status === 'active').length;
    const completedProjects = projects.filter(p => p.status === 'completed').length;
    const overdueProjects = projects.filter(p => {
      if (p.status === 'completed') return false;
      return p.end_date && new Date(p.end_date) < new Date();
    }).length;

    console.log(`
üìà M√âTRIQUES PROJETS:
   - Total: ${totalProjects}
   - Actifs: ${activeProjects}
   - Termin√©s: ${completedProjects}
   - En retard: ${overdueProjects}
    `);

    // Test Export CSV
    console.log('üìÑ Test Export CSV...');
    const csvData = projects.map(p => ({
      Nom: p.name,
      Statut: p.status,
      Priorit√©: p.priority,
      'Date d√©but': formatDateForExport(p.start_date),
      'Date fin': formatDateForExport(p.end_date),
      Budget: formatCurrencyForExport(p.budget),
    }));

    const csvContent = require('../src/lib/exportUtils').convertToCSV(csvData);
    const csvPath = path.join(OUTPUT_DIR, `test-projets-${Date.now()}.csv`);
    fs.writeFileSync(csvPath, '\uFEFF' + csvContent);
    console.log(`‚úÖ CSV g√©n√©r√©: ${csvPath}`);

    // Test Export PDF Tabulaire
    console.log('üìÑ Test Export PDF Tableau...');
    const pdfTableData = projects.slice(0, 20).map(p => ({
      nom: p.name || 'Sans nom',
      statut: p.status || 'N/A',
      priorite: p.priority || 'N/A',
      debut: formatDateForExport(p.start_date),
      fin: formatDateForExport(p.end_date),
    }));

    await exportTableToPDF(
      pdfTableData,
      [
        { header: 'Nom', dataKey: 'nom', width: 60 },
        { header: 'Statut', dataKey: 'statut', width: 30 },
        { header: 'Priorit√©', dataKey: 'priorite', width: 30 },
        { header: 'D√©but', dataKey: 'debut', width: 30 },
        { header: 'Fin', dataKey: 'fin', width: 30 },
      ],
      {
        title: 'TEST - Rapport Projets',
        subtitle: `${totalProjects} projets analys√©s`,
        filename: path.join(OUTPUT_DIR, `test-projets-tableau-${Date.now()}.pdf`),
        footer: 'Test g√©n√©r√© par script automatique',
      }
    );
    console.log('‚úÖ PDF Tableau g√©n√©r√©');

    // Test Export PDF Complet
    console.log('üìÑ Test Export PDF Complet...');
    const metrics = [
      { label: 'Total Projets', value: totalProjects },
      { label: 'Actifs', value: activeProjects },
      { label: 'Termin√©s', value: completedProjects },
      { label: 'En Retard', value: overdueProjects },
    ];

    await exportHybridPDF(
      metrics,
      pdfTableData,
      [
        { header: 'Nom', dataKey: 'nom' },
        { header: 'Statut', dataKey: 'statut' },
        { header: 'Priorit√©', dataKey: 'priorite' },
        { header: 'D√©but', dataKey: 'debut' },
        { header: 'Fin', dataKey: 'fin' },
      ],
      {
        title: 'TEST - Rapport Complet Projets',
        subtitle: `Analyse compl√®te ‚Ä¢ ${totalProjects} projets`,
        filename: path.join(OUTPUT_DIR, `test-projets-complet-${Date.now()}.pdf`),
        footer: 'Test g√©n√©r√© par script automatique',
      }
    );
    console.log('‚úÖ PDF Complet g√©n√©r√©');

    return {
      success: true,
      projectsCount: totalProjects,
      metrics: { totalProjects, activeProjects, completedProjects, overdueProjects },
    };
  } catch (error: any) {
    console.error('‚ùå Erreur test projets:', error.message);
    return { success: false, error: error.message };
  }
}

// =====================================================
// 2. TEST DASHBOARD RH
// =====================================================

async function testHRDashboard() {
  console.log('\nüë• TEST DASHBOARD RH\n' + '='.repeat(50));

  try {
    // R√©cup√©rer les employ√©s
    const { data: employees, error: empError } = await supabase
      .from('employees')
      .select('*')
      .limit(100);

    if (empError) throw empError;

    // R√©cup√©rer les demandes de cong√©s
    const { data: leaveRequests, error: leaveError } = await supabase
      .from('leave_requests')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100);

    if (leaveError) throw leaveError;

    console.log(`‚úÖ ${employees?.length || 0} employ√©s r√©cup√©r√©s`);
    console.log(`‚úÖ ${leaveRequests?.length || 0} demandes de cong√©s r√©cup√©r√©es`);

    if (!employees || employees.length === 0) {
      console.log('‚ö†Ô∏è  Aucune donn√©e RH - Test avec donn√©es mock√©es');
      return testWithMockHR();
    }

    // Calculer les m√©triques
    const totalEmployees = employees.length;
    const pendingRequests = leaveRequests?.filter(r => r.status === 'pending').length || 0;
    const approvedRequests = leaveRequests?.filter(r => r.status === 'approved').length || 0;
    const rejectedRequests = leaveRequests?.filter(r => r.status === 'rejected').length || 0;

    console.log(`
üìà M√âTRIQUES RH:
   - Total Employ√©s: ${totalEmployees}
   - Demandes en attente: ${pendingRequests}
   - Demandes approuv√©es: ${approvedRequests}
   - Demandes rejet√©es: ${rejectedRequests}
    `);

    // Test Export CSV
    console.log('üìÑ Test Export CSV Cong√©s...');
    const csvData = (leaveRequests || []).map(r => {
      const employee = employees.find(e => e.id === r.employee_id);
      return {
        Employ√©: employee?.full_name || 'Inconnu',
        'Date d√©but': formatDateForExport(r.start_date),
        'Date fin': formatDateForExport(r.end_date),
        'Nombre jours': r.total_days,
        Statut: r.status === 'approved' ? 'Approuv√©e' : r.status === 'rejected' ? 'Rejet√©e' : 'En attente',
      };
    });

    const csvContent = require('../src/lib/exportUtils').convertToCSV(csvData);
    const csvPath = path.join(OUTPUT_DIR, `test-conges-${Date.now()}.csv`);
    fs.writeFileSync(csvPath, '\uFEFF' + csvContent);
    console.log(`‚úÖ CSV g√©n√©r√©: ${csvPath}`);

    // Test Export PDF
    console.log('üìÑ Test Export PDF RH...');
    const pdfData = (leaveRequests || []).slice(0, 20).map(r => {
      const employee = employees.find(e => e.id === r.employee_id);
      return {
        employe: employee?.full_name || 'Inconnu',
        debut: formatDateForExport(r.start_date),
        fin: formatDateForExport(r.end_date),
        jours: r.total_days?.toString() || '0',
        statut: r.status === 'approved' ? 'Approuv√©e' : r.status === 'rejected' ? 'Rejet√©e' : 'En attente',
      };
    });

    await exportTableToPDF(
      pdfData,
      [
        { header: 'Employ√©', dataKey: 'employe', width: 50 },
        { header: 'D√©but', dataKey: 'debut', width: 30 },
        { header: 'Fin', dataKey: 'fin', width: 30 },
        { header: 'Jours', dataKey: 'jours', width: 20 },
        { header: 'Statut', dataKey: 'statut', width: 35 },
      ],
      {
        title: 'TEST - Rapport Cong√©s',
        subtitle: `${leaveRequests?.length || 0} demandes`,
        filename: path.join(OUTPUT_DIR, `test-conges-${Date.now()}.pdf`),
        footer: 'Test g√©n√©r√© par script automatique',
      }
    );
    console.log('‚úÖ PDF g√©n√©r√©');

    return {
      success: true,
      employeesCount: totalEmployees,
      requestsCount: leaveRequests?.length || 0,
      metrics: { totalEmployees, pendingRequests, approvedRequests, rejectedRequests },
    };
  } catch (error: any) {
    console.error('‚ùå Erreur test RH:', error.message);
    return { success: false, error: error.message };
  }
}

// =====================================================
// 3. TESTS AVEC DONN√âES MOCK√âES (Fallback)
// =====================================================

async function testWithMockProjects() {
  console.log('üé≠ Test avec donn√©es mock√©es PROJETS');
  
  const mockProjects = Array.from({ length: 10 }, (_, i) => ({
    id: `mock-${i}`,
    name: `Projet Test ${i + 1}`,
    status: ['active', 'completed', 'on_hold'][i % 3],
    priority: ['high', 'medium', 'low'][i % 3],
    start_date: new Date(2025, 0, i + 1).toISOString(),
    end_date: new Date(2025, 2, i + 15).toISOString(),
    budget: (i + 1) * 10000,
  }));

  console.log(`‚úÖ ${mockProjects.length} projets mock√©s cr√©√©s`);
  return { success: true, mocked: true, projectsCount: mockProjects.length };
}

async function testWithMockHR() {
  console.log('üé≠ Test avec donn√©es mock√©es RH');
  
  const mockEmployees = Array.from({ length: 5 }, (_, i) => ({
    id: `emp-${i}`,
    full_name: `Employ√© Test ${i + 1}`,
  }));

  console.log(`‚úÖ ${mockEmployees.length} employ√©s mock√©s cr√©√©s`);
  return { success: true, mocked: true, employeesCount: mockEmployees.length };
}

// =====================================================
// 4. EX√âCUTION DES TESTS
// =====================================================

async function runAllTests() {
  console.log('\n' + '='.repeat(60));
  console.log('üß™ D√âMARRAGE TESTS DASHBOARDS AVEC DONN√âES R√âELLES');
  console.log('='.repeat(60));
  console.log(`üìÅ Dossier de sortie: ${OUTPUT_DIR}\n`);

  const results: any = {
    timestamp: new Date().toISOString(),
    tests: {},
  };

  // Test Projets
  const projectsResult = await testProjectsDashboard();
  results.tests.projects = projectsResult;

  // Test RH
  const hrResult = await testHRDashboard();
  results.tests.hr = hrResult;

  // R√©sum√©
  console.log('\n' + '='.repeat(60));
  console.log('üìä R√âSUM√â DES TESTS');
  console.log('='.repeat(60));
  console.log(`
‚úÖ Dashboard Projets: ${projectsResult.success ? 'SUCC√àS' : '√âCHEC'}
   ${(projectsResult as any).mocked ? '(Donn√©es mock√©es)' : `(${projectsResult.projectsCount} projets r√©els)`}

‚úÖ Dashboard RH: ${hrResult.success ? 'SUCC√àS' : '√âCHEC'}
   ${(hrResult as any).mocked ? '(Donn√©es mock√©es)' : `(${(hrResult as any).employeesCount} employ√©s r√©els)`}

üìÅ Fichiers g√©n√©r√©s dans: ${OUTPUT_DIR}
  `);

  // Sauvegarder le rapport JSON
  const reportPath = path.join(OUTPUT_DIR, `test-report-${Date.now()}.json`);
  fs.writeFileSync(reportPath, JSON.stringify(results, null, 2));
  console.log(`üìÑ Rapport JSON: ${reportPath}\n`);

  return results;
}

// Ex√©cuter les tests
runAllTests()
  .then(() => {
    console.log('‚úÖ Tests termin√©s avec succ√®s\n');
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Erreur fatale:', error);
    process.exit(1);
  });
