import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

// @ts-ignore - Deno global disponible dans l'environnement Edge Functions
declare const Deno: any;
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type'
};
serve(async (req)=>{
  if (req.method === 'OPTIONS') {
    return new Response('ok', {
      headers: corsHeaders
    });
  }
  try {
    console.log('');
    console.log('üöÄ ===== D√âBUT PROCESSUS D\'ENVOI D\'INVITATION =====');
    console.log('‚è∞ Timestamp d√©but:', new Date().toISOString());
    console.log('üåê M√©thode:', req.method);
    console.log('üîó URL:', req.url);
    console.log('');
    
    const supabaseClient = createClient(Deno.env.get('SUPABASE_URL') ?? '', Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '');
    console.log('‚úÖ Client Supabase initialis√© avec Service Role');
    // V√©rifier l'authentification
    console.log('üîç √âTAPE 1: V√©rification authentification...');
    const authHeader = req.headers.get('Authorization');
    console.log('   - Header Authorization pr√©sent:', !!authHeader);
    
    if (!authHeader) {
      console.error('‚ùå √âCHEC √âTAPE 1: Header Authorization manquant');
      return new Response(JSON.stringify({
        error: 'Header Authorization requis'
      }), {
        status: 401,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }
    
    const token = authHeader.replace('Bearer ', '');
    console.log('   - Token extrait (longueur):', token.length);
    
    const authStart = Date.now();
    const { data: { user }, error: authError } = await supabaseClient.auth.getUser(token);
    const authEnd = Date.now();
    
    console.log('   - Dur√©e v√©rification auth:', (authEnd - authStart), 'ms');
    
    if (authError || !user) {
      console.error('‚ùå √âCHEC √âTAPE 1: Authentification √©chou√©e');
      console.error('   - Erreur:', authError?.message || 'Utilisateur null');
      return new Response(JSON.stringify({
        error: 'Token invalide ou expir√©',
        details: authError?.message
      }), {
        status: 401,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }
    
    console.log('‚úÖ √âTAPE 1 R√âUSSIE: Utilisateur authentifi√©');
    console.log('   - User ID:', user.id);
    console.log('   - Email:', user.email);
    // V√©rifier que l'utilisateur est Super Admin
    const { data: isSuperAdmin, error: roleError } = await supabaseClient.rpc('is_super_admin', {
      user_id: user.id
    });
    if (roleError || !isSuperAdmin) {
      return new Response(JSON.stringify({
        error: 'Acc√®s Super Admin requis'
      }), {
        status: 403,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    const { email, fullName, invitationType = 'tenant_owner', siteUrl } = await req.json();
    // Validation des donn√©es
    if (!email || !fullName) {
      return new Response(JSON.stringify({
        error: 'Email et nom complet requis'
      }), {
        status: 400,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    // G√©n√©rer l'UUID du futur tenant
    const futureTenantId = crypto.randomUUID();
    // G√©n√©rer un mot de passe temporaire
    const tempPassword = Math.random().toString(36).slice(-8) + Math.random().toString(36).slice(-4).toUpperCase() + '1!';
    console.log('Generated temp password:', tempPassword);
    
    // üéØ G√©n√©rer tous les √©l√©ments de validation requis (au niveau global)
    const invitationTimestamp = new Date().toISOString();
    const invitationId = crypto.randomUUID();
    const validationCode = Math.random().toString(36).substring(2, 15);
    
    console.log('üìã G√©n√©ration des √©l√©ments de validation:');
    console.log('   - Invitation ID:', invitationId);
    console.log('   - Tenant ID:', futureTenantId);
    console.log('   - Validation Code:', validationCode);
    console.log('   - Timestamp:', invitationTimestamp);
    // V√©rifier d'abord si l'utilisateur existe d√©j√†
    console.log('Checking if user already exists for email:', email);
    let userData;
    const { data: existingUsers } = await supabaseClient.auth.admin.listUsers();
    const existingUser = existingUsers?.users?.find((u)=>u.email === email.toLowerCase());
    if (existingUser) {
      console.log('User already exists, using existing user:', existingUser.id);
      userData = {
        user: existingUser
      };
    } else {
      // Cr√©er un utilisateur temporaire avec Supabase Auth
      console.log('Creating temporary user for email:', email);
      console.log('Using pre-generated validation elements for user creation...');
      
      const { data: newUserData, error: userError } = await supabaseClient.auth.admin.createUser({
        email: email,
        password: tempPassword,
        email_confirm: false,
        user_metadata: {
          // üéØ √âL√âMENTS DE VALIDATION REQUIS (10 √©l√©ments)
          full_name: fullName,                    // 1. Nom complet
          invitation_type: 'tenant_owner',        // 2. Type d'invitation
          temp_user: true,                        // 3. Flag utilisateur temporaire
          temp_password: tempPassword,            // 4. Mot de passe temporaire
          tenant_id: futureTenantId,             // 5. ID du futur tenant
          invitation_id: invitationId,           // 6. ID unique d'invitation
          validation_code: validationCode,       // 7. Code de validation
          created_timestamp: invitationTimestamp, // 8. Timestamp de cr√©ation
          invited_by_type: 'super_admin',        // 9. Type d'inviteur
          company_name: fullName.split(' ')[0] + ' Company', // 10. Nom de l'entreprise
          
          // M√©tadonn√©es suppl√©mentaires pour la robustesse
          invitation_source: 'admin_panel',
          expected_role: 'tenant_admin',
          security_level: 'standard',
          locale: 'fr-FR'
        }
      });
      
      if (userError) {
        console.error('Error creating user:', userError);
        console.error('User error details:', JSON.stringify(userError, null, 2));
        
        // Gestion sp√©cifique des erreurs d'authentification
        if (userError.code === 'email_exists') {
          return new Response(JSON.stringify({
            error: 'Cet email est d√©j√† utilis√©',
            code: 'EMAIL_ALREADY_EXISTS',
            message: `L'adresse email ${email} est d√©j√† enregistr√©e dans le syst√®me. Veuillez utiliser une autre adresse email ou contacter l'administrateur si cette personne doit √™tre invit√©e.`,
            details: {
              email: email,
              suggestion: 'V√©rifiez si cette personne a d√©j√† un compte ou utilisez une autre adresse email'
            }
          }), {
            status: 409, // Conflict
            headers: {
              ...corsHeaders,
              'Content-Type': 'application/json'
            }
          });
        }
        
        if (userError.code === 'invalid_email') {
          return new Response(JSON.stringify({
            error: 'Format d\'email invalide',
            code: 'INVALID_EMAIL_FORMAT',
            message: `L'adresse email "${email}" n'est pas dans un format valide.`,
            details: {
              email: email,
              suggestion: 'V√©rifiez le format de l\'adresse email (exemple: nom@domaine.com)'
            }
          }), {
            status: 400, // Bad Request
            headers: {
              ...corsHeaders,
              'Content-Type': 'application/json'
            }
          });
        }
        
        if (userError.code === 'weak_password') {
          return new Response(JSON.stringify({
            error: 'Mot de passe temporaire faible',
            code: 'WEAK_PASSWORD',
            message: 'Le mot de passe g√©n√©r√© automatiquement ne respecte pas les crit√®res de s√©curit√©.',
            details: {
              suggestion: 'Veuillez r√©essayer, un nouveau mot de passe sera g√©n√©r√©'
            }
          }), {
            status: 400,
            headers: {
              ...corsHeaders,
              'Content-Type': 'application/json'
            }
          });
        }
        
        if (userError.code === 'signup_disabled') {
          return new Response(JSON.stringify({
            error: 'Inscription d√©sactiv√©e',
            code: 'SIGNUP_DISABLED',
            message: 'La cr√©ation de nouveaux comptes est temporairement d√©sactiv√©e.',
            details: {
              suggestion: 'Contactez l\'administrateur syst√®me'
            }
          }), {
            status: 503, // Service Unavailable
            headers: {
              ...corsHeaders,
              'Content-Type': 'application/json'
            }
          });
        }
        
        // Erreur g√©n√©rique pour les autres cas
        return new Response(JSON.stringify({
          error: 'Erreur lors de la cr√©ation du compte',
          code: 'USER_CREATION_FAILED',
          message: 'Une erreur est survenue lors de la cr√©ation du compte utilisateur.',
          details: {
            error_code: userError.code || 'unknown',
            suggestion: 'Veuillez r√©essayer ou contacter l\'administrateur'
          }
        }), {
          status: 500,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json'
          }
        });
      } else {
        userData = newUserData;
        console.log('User created successfully:', userData.user?.id);
      }
    }
    
    // üîß SOLUTION 4: G√©n√©rer un NOUVEAU token de confirmation
    console.log('üîÑ G√©n√©ration d\'un nouveau token de confirmation...');
    console.log('   - User ID:', userData.user?.id);
    console.log('   - Email:', email);
    
    const { data: newLinkData, error: newLinkError } = await supabaseClient.auth.admin.generateLink({
      type: 'signup',
      email: email,
      options: {
        redirectTo: `http://localhost:8080/auth/callback?email=${encodeURIComponent(email)}`
      }
    });
    
    if (newLinkError) {
      console.error('‚ùå Erreur g√©n√©ration nouveau token:', newLinkError);
      return new Response(JSON.stringify({
        error: 'Erreur g√©n√©ration token de confirmation',
        code: 'TOKEN_GENERATION_FAILED',
        details: newLinkError
      }), {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }
    
    // Extraire le nouveau token de l'URL
    const newToken = newLinkData.properties.action_link.match(/token=([^&]+)/)?.[1];
    
    if (!newToken) {
      console.error('‚ùå Impossible d\'extraire le token de l\'URL:', newLinkData.properties.action_link);
      return new Response(JSON.stringify({
        error: 'Token non trouv√© dans l\'URL g√©n√©r√©e',
        code: 'TOKEN_EXTRACTION_FAILED'
      }), {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }
    
    console.log('‚úÖ Nouveau token g√©n√©r√© avec succ√®s:');
    console.log('   - Token (d√©but):', newToken.substring(0, 20) + '...');
    console.log('   - URL compl√®te:', newLinkData.properties.action_link);
    
    // G√©n√©rer un lien de confirmation avec token (ANCIEN CODE - maintenant avec nouveau token)
    // Utiliser 'signup' car l'utilisateur doit confirmer son email
    // IMPORTANT: Utiliser l'email du destinataire r√©el, pas celui du d√©veloppeur
    const { data: linkData, error: linkError } = await supabaseClient.auth.admin.generateLink({
      type: 'signup',
      email: email, // Email du destinataire r√©el
      password: tempPassword,
      options: {
        redirectTo: `${siteUrl}/auth/callback?email=${encodeURIComponent(email)}`
      }
    });
    if (linkError) {
      console.error('Error generating link:', linkError);
      
      return new Response(JSON.stringify({
        error: 'Erreur g√©n√©ration du lien d\'invitation',
        code: 'LINK_GENERATION_FAILED',
        message: 'Impossible de g√©n√©rer le lien d\'invitation pour cet utilisateur.',
        details: {
          error_code: linkError.code || 'unknown',
          suggestion: 'Veuillez r√©essayer ou contacter l\'administrateur'
        }
      }), {
        status: 500,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    console.log('Generated link data:', linkData);
    // Extraire le token du lien g√©n√©r√©
    const url = new URL(linkData.properties.action_link);
    const supabaseToken = url.searchParams.get('token');
    if (!supabaseToken) {
      return new Response(JSON.stringify({
        error: 'Token d\'invitation manquant',
        code: 'MISSING_INVITATION_TOKEN',
        message: 'Impossible d\'extraire le token du lien d\'invitation g√©n√©r√©.',
        details: {
          suggestion: 'Veuillez r√©essayer la cr√©ation de l\'invitation'
        }
      }), {
        status: 500,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    // Cr√©er l'invitation avec le token Supabase Auth et tous les √©l√©ments de validation
    const expirationDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    const invitationMetadata = {
      // Donn√©es utilisateur Supabase
      supabase_user_id: userData.user?.id,
      confirmation_url: newLinkData.properties.action_link,  // ‚úÖ NOUVEAU TOKEN
      fresh_token: newToken,  // ‚úÖ TOKEN FRAIS STOCK√â
      temp_password: tempPassword,
      
      // üéØ √âL√âMENTS DE VALIDATION COMPLETS (utilisant les variables locales)
      validation_elements: {
        full_name: fullName,                           // 1. Nom complet
        invitation_type: 'tenant_owner',               // 2. Type d'invitation  
        temp_user: true,                              // 3. Flag utilisateur temporaire
        temp_password: tempPassword,                  // 4. Mot de passe temporaire
        tenant_id: futureTenantId,                   // 5. ID du futur tenant
        invitation_id: invitationId,                 // 6. ID unique
        validation_code: validationCode,             // 7. Code validation
        created_timestamp: invitationTimestamp,      // 8. Timestamp
        invited_by_type: 'super_admin',              // 9. Type d'inviteur
        company_name: fullName.split(' ')[0] + ' Company' // 10. Nom entreprise
      },
      
      // Donn√©es de s√©curit√© et audit
      security_info: {
        ip_address: req.headers.get('x-forwarded-for') || 'unknown',
        user_agent: req.headers.get('user-agent') || 'unknown',
        invitation_source: 'admin_panel',
        security_level: 'standard'
      },
      
      // Donn√©es de configuration
      config: {
        locale: 'fr-FR',
        timezone: 'Europe/Paris',
        expected_role: 'tenant_admin',
        auto_confirm: true
      }
    };
    
    console.log('üì¶ M√©tadonn√©es d\'invitation compl√®tes:', JSON.stringify(invitationMetadata, null, 2));
    
    console.log('');
    console.log('üîç √âTAPE 9: Cr√©ation de l\'invitation dans la table invitations...');
    console.log('   - Token Frais (nouveau):', newToken ? 'PR√âSENT' : 'MANQUANT');
    console.log('   - Token Ancien (supabase):', supabaseToken ? 'PR√âSENT' : 'MANQUANT');
    console.log('   - Email:', email.toLowerCase());
    console.log('   - Nom complet:', fullName);
    console.log('   - Tenant ID:', futureTenantId);
    console.log('   - Type invitation:', invitationType);
    console.log('   - Invit√© par:', user.id);
    console.log('   - Expire le:', expirationDate.toISOString());
    console.log('   - M√©tadonn√©es:', Object.keys(invitationMetadata).length, 'sections');
    
    const invitationStart = Date.now();
    const { data: invitation, error: invitationError } = await supabaseClient.from('invitations').insert({
      token: newToken,  // ‚úÖ UTILISER LE NOUVEAU TOKEN FRAIS au lieu de supabaseToken
      email: email.toLowerCase(),
      full_name: fullName,
      tenant_id: futureTenantId,
      invitation_type: invitationType,
      invited_by: user.id,
      expires_at: expirationDate.toISOString(),
      metadata: invitationMetadata
    }).select().single();
    
    const invitationEnd = Date.now();
    console.log('   - Dur√©e insertion:', (invitationEnd - invitationStart), 'ms');
    if (invitationError) {
      console.error('Erreur cr√©ation invitation:', invitationError);
      
      // Gestion sp√©cifique des erreurs de base de donn√©es
      if (invitationError.code === '23505') { // Violation de contrainte unique
        return new Response(JSON.stringify({
          error: 'Invitation d√©j√† existante',
          code: 'INVITATION_ALREADY_EXISTS',
          message: `Une invitation pour l'email ${email} existe d√©j√† et est en attente.`,
          details: {
            email: email,
            suggestion: 'V√©rifiez les invitations en attente ou annulez l\'invitation existante'
          }
        }), {
          status: 409,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json'
          }
        });
      }
      
      if (invitationError.code === '23503') { // Violation de cl√© √©trang√®re
        return new Response(JSON.stringify({
          error: 'R√©f√©rence invalide',
          code: 'INVALID_REFERENCE',
          message: 'Une r√©f√©rence dans l\'invitation n\'est pas valide (utilisateur invitant ou r√¥le).',
          details: {
            suggestion: 'V√©rifiez que l\'utilisateur qui invite existe et a les permissions'
          }
        }), {
          status: 400,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json'
          }
        });
      }
      
      return new Response(JSON.stringify({
        error: 'Erreur lors de la cr√©ation de l\'invitation',
        code: 'INVITATION_CREATION_FAILED',
        message: 'Impossible de cr√©er l\'invitation en base de donn√©es.',
        details: {
          error_code: invitationError.code || 'unknown',
          suggestion: 'Veuillez r√©essayer ou contacter l\'administrateur'
        }
      }), {
        status: 500,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    
    console.log('');
    console.log('‚úÖ √âTAPE 9 R√âUSSIE: Invitation cr√©√©e dans la base de donn√©es!');
    console.log('   - ID invitation:', invitation.id);
    console.log('   - Email:', invitation.email);
    console.log('   - Tenant ID:', invitation.tenant_id);
    console.log('   - Type:', invitation.invitation_type);
    console.log('   - Status:', invitation.status);
    console.log('   - Expire le:', invitation.expires_at);
    console.log('   - Cr√©√©e le:', invitation.created_at);
    console.log('   - Token pr√©sent:', !!invitation.token);
    console.log('   - M√©tadonn√©es pr√©sentes:', !!invitation.metadata);
    console.log('');
    
    // Enrichir le lien avec les param√®tres de validation
    const baseUrl = new URL(linkData.properties.action_link);
    
    // üéØ √âTAPE 8: Enrichissement de l'URL avec les 10 √©l√©ments de validation
    console.log('');
    console.log('üîó √âTAPE 8: Enrichissement URL avec √©l√©ments de validation...');
    
    // R√©cup√©rer les √©l√©ments de validation depuis les variables locales g√©n√©r√©es
    // (plus fiable que les m√©tadonn√©es utilisateur qui peuvent √™tre incompl√®tes)
    const validationElements = {
      invitation_id: invitationId,
      validation_code: validationCode,
      created_timestamp: invitationTimestamp,
      company_name: fullName.split(' ')[0] + ' Company'
    };
    
    console.log('üìä √âL√âMENTS DE VALIDATION R√âCUP√âR√âS:');
    console.log('   - invitation_id:', validationElements.invitation_id || 'MANQUANT');
    console.log('   - validation_code:', validationElements.validation_code || 'MANQUANT');
    console.log('   - created_timestamp:', validationElements.created_timestamp || 'MANQUANT');
    console.log('   - company_name:', validationElements.company_name || 'MANQUANT');
    
    // V√©rifier que tous les √©l√©ments critiques sont pr√©sents
    const missingElements: string[] = [];
    if (!validationElements.invitation_id) missingElements.push('invitation_id');
    if (!validationElements.validation_code) missingElements.push('validation_code');
    if (!validationElements.created_timestamp) missingElements.push('created_timestamp');
    
    if (missingElements.length > 0) {
      console.error('‚ùå √âL√âMENTS DE VALIDATION MANQUANTS:', missingElements);
      throw new Error(`√âl√©ments de validation manquants: ${missingElements.join(', ')}`);
    }
    
    console.log('‚úÖ Tous les √©l√©ments critiques pr√©sents - Enrichissement URL...');
    
    // Enrichir l'URL avec TOUS les param√®tres de validation
    baseUrl.searchParams.set('email', email);
    baseUrl.searchParams.set('tenant_id', futureTenantId);
    baseUrl.searchParams.set('invitation_id', validationElements.invitation_id);
    baseUrl.searchParams.set('validation_code', validationElements.validation_code);
    baseUrl.searchParams.set('full_name', encodeURIComponent(fullName));
    baseUrl.searchParams.set('invitation_type', 'tenant_owner');
    baseUrl.searchParams.set('created_timestamp', validationElements.created_timestamp);
    baseUrl.searchParams.set('company_name', encodeURIComponent(validationElements.company_name));
    
    const finalInvitationUrl = baseUrl.toString();
    
    console.log('');
    console.log('üéØ URL FINALE ENRICHIE G√âN√âR√âE:');
    console.log('   - URL compl√®te:', finalInvitationUrl);
    console.log('   - Param√®tres inclus: 8/10 √©l√©ments de validation');
    console.log('   - Longueur URL:', finalInvitationUrl.length, 'caract√®res');
    console.log('');
    console.log('‚úÖ √âTAPE 8 R√âUSSIE: URL enrichie avec validation compl√®te');
    console.log('');
    const emailHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Invitation Wadashaqeen</title>
      </head>
      <body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white; text-align: center;">
          <h1 style="margin: 0; font-size: 28px;">Invitation Wadashaqeen</h1>
          <p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">Plateforme de gestion d'entreprise</p>
        </div>
        
        <div style="padding: 30px; background: #f8f9fa; border-radius: 10px; margin-top: 20px;">
          <h2 style="color: #333; margin-top: 0;">Message d'invitation</h2>
          
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="margin: 0; color: #856404; font-size: 14px; font-weight: bold;">
              üß™ <strong>MODE TEST - Invitation s√©curis√©e cr√©√©e</strong><br>
              üìß <strong>Destinataire r√©el :</strong> <span style="font-size: 16px; color: #333;">${email}</span><br>
              üì¨ <strong>Notification envoy√©e √† :</strong> <span style="font-size: 16px; color: #333;">osman.awaleh.adn@gmail.com</span><br>
              üîê <strong>√âl√©ments de validation :</strong> <span style="color: #28a745;">10/10 g√©n√©r√©s</span><br>
              üè¢ <strong>Entreprise :</strong> ${userData.user?.raw_user_meta_data?.company_name || 'Non d√©finie'}
            </p>
          </div>
          
          <p style="color: #666; line-height: 1.6; font-size: 16px;">
            <strong>Veuillez transmettre ce message √† l'adresse ${email}</strong>
          </p>
          
          <p style="color: #666; line-height: 1.6; font-size: 16px;">
            Bonjour <strong>${fullName}</strong>,<br><br>
            Vous √™tes invit√©(e) √† cr√©er votre compte entreprise sur <strong>Wadashaqeen</strong>, 
            la plateforme compl√®te de gestion d'entreprise.
          </p>
          
          <p style="color: #666; line-height: 1.6; font-size: 16px;">
            En tant que propri√©taire d'entreprise, vous aurez acc√®s √† tous nos modules :
          </p>
          
          <ul style="color: #666; line-height: 1.8;">
            <li>üìä Gestion des projets et t√¢ches</li>
            <li>üë• Gestion des ressources humaines</li>
            <li>üìà Tableaux de bord et analytics</li>
            <li>üîî Syst√®me d'alertes intelligent</li>
            <li>‚öôÔ∏è Administration compl√®te</li>
          </ul>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="${finalInvitationUrl}" 
               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      color: white; 
                      padding: 15px 30px; 
                      text-decoration: none; 
                      border-radius: 8px; 
                      font-weight: bold; 
                      font-size: 16px;
                      display: inline-block;">
              üöÄ Cr√©er mon compte entreprise
            </a>
          </div>
          
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="margin: 0; color: #856404; font-size: 14px;">
              üîë <strong>Informations de connexion :</strong><br>
              <span style="font-size: 18px; font-weight: bold; color: #333; background: white; padding: 5px 10px; border-radius: 4px; display: inline-block; margin: 5px 0;">${tempPassword}</span><br>
              üìã <strong>ID Invitation :</strong> <code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${userData.user?.raw_user_meta_data?.invitation_id || 'N/A'}</code><br>
              üè¢ <strong>ID Tenant :</strong> <code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${futureTenantId}</code><br><br>
              <small>Ces informations sont automatiquement valid√©es lors de votre premi√®re connexion. Vous pourrez changer votre mot de passe apr√®s l'activation.</small>
            </p>
          </div>
          
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="margin: 0; color: #1565c0; font-size: 14px;">
              ‚è∞ <strong>Cette invitation expire le ${expirationDate.toLocaleDateString('fr-FR')} √† ${expirationDate.toLocaleTimeString('fr-FR')}.</strong><br>
              üìß <strong>Votre email (${email}) sera pr√©-rempli dans le formulaire.</strong><br>
              üîê <strong>Validation automatique :</strong> Toutes vos informations sont pr√©-configur√©es.<br><br>
              üí° <strong>Processus simplifi√© :</strong><br>
              1Ô∏è‚É£ Cliquez sur le lien ci-dessus<br>
              2Ô∏è‚É£ Saisissez votre mot de passe temporaire<br>
              3Ô∏è‚É£ Votre entreprise sera automatiquement configur√©e<br><br>
              Si le lien ne fonctionne pas, copiez-collez cette URL dans votre navigateur :<br>
              <code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; word-break: break-all;">${finalInvitationUrl}</code>
            </p>
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; color: #999; font-size: 14px;">
          <p>¬© 2024 Wadashaqeen - Plateforme de gestion d'entreprise</p>
          <p>Si vous n'avez pas demand√© cette invitation, vous pouvez ignorer cet email.</p>
        </div>
      </body>
      </html>
    `;
    console.log('üìß Pr√©paration envoi email via Resend...');
    console.log('   - Destinataire:', email);
    console.log('   - Cl√© API Resend disponible:', Deno.env.get('RESEND_API_KEY') ? 'OUI' : 'NON');
    // Utiliser Resend pour envoyer l'email
    console.log('');
    console.log('üìß √âTAPE 10: Envoi de l\'email d\'invitation...');
    console.log('   - Destinataire r√©el:', email);
    console.log('   - Destinataire email:', process.env.NODE_ENV === 'production' ? email : 'osman.awaleh.adn@gmail.com');
    console.log('   - Sujet:', process.env.NODE_ENV === 'production' 
      ? `Invitation Wadashaqeen - ${fullName}` 
      : `üß™ [TEST] Invitation cr√©√©e pour ${email} - ${fullName}`);
    console.log('   - URL finale longueur:', finalInvitationUrl.length, 'caract√®res');
    console.log('   - Cl√© Resend pr√©sente:', !!Deno.env.get('RESEND_API_KEY'));
    console.log('   - HTML email longueur:', emailHtml.length, 'caract√®res');
    
    const emailStart = Date.now();
    const resendResponse = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${Deno.env.get('RESEND_API_KEY')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        from: 'Wadashaqeen <onboarding@resend.dev>',
        to: [
          // En mode d√©veloppement, envoyer √† votre email mais avec les bonnes informations
          process.env.NODE_ENV === 'production' ? email : 'osman.awaleh.adn@gmail.com'
        ],
        subject: process.env.NODE_ENV === 'production' 
          ? `Invitation Wadashaqeen - ${fullName}` 
          : `üß™ [TEST] Invitation cr√©√©e pour ${email} - ${fullName}`,
        html: emailHtml
      })
    });
    
    const emailEnd = Date.now();
    console.log('   - Dur√©e envoi email:', (emailEnd - emailStart), 'ms');
    console.log('   - Status r√©ponse:', resendResponse.status);
    if (!resendResponse.ok) {
      const errorText = await resendResponse.text();
      console.error('');
      console.error('‚ùå √âCHEC √âTAPE 10: Erreur envoi email Resend');
      console.error('   - Status HTTP:', resendResponse.status);
      console.error('   - Status Text:', resendResponse.statusText);
      console.error('   - R√©ponse brute:', errorText);
      console.error('   - Headers:', Object.fromEntries(resendResponse.headers.entries()));
      console.error('');
      
      let errorResponse;
      try {
        const errorJson = JSON.parse(errorText);
        
        // Gestion sp√©cifique des erreurs Resend
        if (resendResponse.status === 401) {
          errorResponse = {
            error: 'Cl√© API invalide',
            code: 'INVALID_API_KEY',
            message: 'La cl√© API Resend n\'est pas valide ou a expir√©.',
            details: {
              suggestion: 'V√©rifiez la configuration de la cl√© API Resend'
            }
          };
        } else if (resendResponse.status === 429) {
          errorResponse = {
            error: 'Limite d\'envoi atteinte',
            code: 'RATE_LIMIT_EXCEEDED',
            message: 'La limite d\'envoi d\'emails a √©t√© atteinte.',
            details: {
              suggestion: 'Attendez quelques minutes avant de r√©essayer'
            }
          };
        } else {
          errorResponse = {
            error: 'Erreur service email',
            code: 'EMAIL_SERVICE_ERROR',
            message: 'Le service d\'envoi d\'email a rencontr√© une erreur.',
            details: {
              status: resendResponse.status,
              error_details: errorJson.message || errorText,
              suggestion: 'Veuillez r√©essayer dans quelques minutes'
            }
          };
        }
      } catch (parseError) {
        errorResponse = {
          error: 'Erreur lors de l\'envoi de l\'email',
          code: 'EMAIL_SEND_FAILED',
          message: 'Impossible d\'envoyer l\'email d\'invitation.',
          details: {
            status: resendResponse.status,
            suggestion: 'Veuillez r√©essayer ou contacter l\'administrateur'
          }
        };
      }
      
      return new Response(JSON.stringify(errorResponse), {
        status: resendResponse.status >= 500 ? 500 : 400,
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    const resendResult = await resendResponse.json();
    
    console.log('');
    console.log('üéâ ===== PROCESSUS D\'ENVOI TERMIN√â AVEC SUCC√àS =====');
    console.log('‚úÖ Email envoy√© avec succ√®s via Resend:');
    console.log('   - ID email:', resendResult.id);
    console.log('   - Destinataire:', email);
    console.log('   - Nom complet:', fullName);
    console.log('   - Type invitation:', 'tenant_owner');
    console.log('   - Tenant ID:', futureTenantId);
    console.log('   - Invitation ID:', invitation.id);
    console.log('   - URL finale:', finalInvitationUrl.length, 'caract√®res');
    console.log('   - √âl√©ments validation: 8/10 inclus dans URL');
    console.log('   - Expiration:', expirationDate.toISOString());
    console.log('');
    console.log('üéØ R√âSUM√â FINAL:');
    console.log('   - Utilisateur temporaire cr√©√©: ‚úÖ');
    console.log('   - 10 √©l√©ments de validation g√©n√©r√©s: ‚úÖ');
    console.log('   - Invitation enregistr√©e en base: ‚úÖ');
    console.log('   - URL enrichie avec validation: ‚úÖ');
    console.log('   - Email envoy√© avec succ√®s: ‚úÖ');
    console.log('');
    console.log('üöÄ L\'utilisateur peut maintenant cliquer sur le lien pour confirmer son compte!');
    console.log('üéâ ========================================================');
    console.log('');
    
    return new Response(JSON.stringify({
      success: true,
      message: 'Invitation envoy√©e avec succ√®s - Processus complet',
      data: {
        invitation_id: invitation.id,
        tenant_id: futureTenantId,
        user_id: userData.user?.id,
        email: email,
        full_name: fullName,
        expires_at: expirationDate.toISOString(),
        validation_elements_count: 10,
        url_parameters_count: 8,
        resend_email_id: resendResult.id
      }
    }), {
      status: 200,
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      }
    });
  } catch (error) {
    console.error('');
    console.error('üí• ===== ERREUR CRITIQUE DANS LE PROCESSUS D\'INVITATION =====');
    console.error('üö® ERREUR FATALE non g√©r√©e:');
    console.error('   - Nom erreur:', error.name || 'NON D√âFINI');
    console.error('   - Message:', error.message || 'NON D√âFINI');
    console.error('   - Stack trace:', error.stack || 'NON DISPONIBLE');
    console.error('   - Timestamp:', new Date().toISOString());
    console.error('');
    console.error('üéØ CONTEXTE DE L\'ERREUR:');
    console.error('   - Processus: Envoi d\'invitation');
    console.error('   - Fonction: send-invitation');
    console.error('   - Environnement: Supabase Edge Function');
    console.error('');
    console.error('üí• ========================================================');
    console.error('');
    
    return new Response(JSON.stringify({
      success: false,
      error: 'Erreur critique dans le processus d\'invitation',
      details: {
        error_name: error.name,
        error_message: error.message,
        error_stack: error.stack,
        timestamp: new Date().toISOString(),
        context: 'send-invitation-process'
      }
    }), {
      status: 500,
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      }
    });
  }
});
