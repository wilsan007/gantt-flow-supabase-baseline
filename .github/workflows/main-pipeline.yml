name: CI/CD Pipeline - Test & Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Quality Checks
  quality-checks:
    name: ðŸ” Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ðŸ” ESLint
        run: npm run lint
        continue-on-error: false
      
      - name: ðŸ’… Prettier
        run: npm run format:check
        continue-on-error: false
      
      - name: ðŸ“ TypeScript
        run: npm run type-check
        continue-on-error: false

  # Job 2: Tests
  tests:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ðŸ§ª Run Tests
        run: npm run test -- --run
        continue-on-error: false

  # Job 3: Build
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ðŸ—ï¸ Build Application
        run: npm run build
        env:
          NODE_ENV: production
          CI: false
      
      - name: ðŸ“Š Build Info
        run: |
          echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist" ]; then
            BUILD_SIZE=$(du -sh dist | cut -f1)
            FILE_COUNT=$(find dist -type f | wc -l)
            echo "ðŸ“¦ **Size:** $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ **Files:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7

  # Job 4: Deploy to Hostinger (SEULEMENT si tous les tests passent)
  deploy:
    name: ðŸš€ Deploy to Hostinger
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    steps:
      - name: ðŸ“¥ Download Build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/
      
      - name: ðŸ“‹ List Files
        run: |
          echo "ðŸ“ Fichiers Ã  dÃ©ployer:"
          ls -lah dist/
      
      - name: ðŸš€ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          dangerous-clean-slate: false
      
      - name: âœ… Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build:** Successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deploy:** Completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Server:** Hostinger" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Votre site est maintenant Ã  jour sur Hostinger!" >> $GITHUB_STEP_SUMMARY

  # Job 5: Notification si Ã©chec
  notify-failure:
    name: âŒ Failure Notification
    runs-on: ubuntu-latest
    needs: [quality-checks, tests, build, deploy]
    if: failure()
    
    steps:
      - name: âŒ Failed Stage
        run: |
          echo "## âŒ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Le dÃ©ploiement n'a pas eu lieu car une Ã©tape a Ã©chouÃ©." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### VÃ©rifiez:" >> $GITHUB_STEP_SUMMARY
          echo "- Les tests unitaires" >> $GITHUB_STEP_SUMMARY
          echo "- Les erreurs ESLint" >> $GITHUB_STEP_SUMMARY
          echo "- Les erreurs de build" >> $GITHUB_STEP_SUMMARY
