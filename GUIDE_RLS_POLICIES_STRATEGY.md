# üîê Strat√©gie RLS (Row Level Security) - Guide Complet

## ‚ö†Ô∏è **PROBL√àME CRITIQUE D√âTECT√â**

**35 tables ont RLS activ√© mais AUCUNE policy** ‚Üí **Toutes les donn√©es sont BLOQU√âES** !

Quand RLS est activ√© sans policies, PostgreSQL **refuse TOUS les acc√®s** par d√©faut.

---

## üìä **Tables Concern√©es (35)**

### **Module RH (10 tables)**
```
‚ùå absences
‚ùå employee_access_logs
‚ùå employee_documents
‚ùå employee_insights
‚ùå employee_payrolls
‚ùå employees
‚ùå skill_assessments
‚ùå tardiness
‚ùå training_enrollments
‚ùå training_programs
```

### **Module √âvaluations (4 tables)**
```
‚ùå evaluations
‚ùå key_results
‚ùå objectives
‚ùå hr_analytics
```

### **Module Recrutement (6 tables)**
```
‚ùå candidates
‚ùå interviews
‚ùå job_applications
‚ùå job_offers
‚ùå job_posts
‚ùå capacity_planning
```

### **Module Finances (5 tables)**
```
‚ùå expense_items
‚ùå expense_reports
‚ùå payroll_components
‚ùå payroll_periods
‚ùå timesheets
```

### **Module Onboarding (4 tables)**
```
‚ùå onboarding_processes
‚ùå onboarding_tasks
‚ùå offboarding_processes
‚ùå offboarding_tasks
```

### **Module S√©curit√© (4 tables)**
```
‚ùå corrective_actions
‚ùå safety_documents
‚ùå safety_incidents
‚ùå task_audit_logs
```

### **Autres (2 tables)**
```
‚ùå country_policies
‚ùå (autres modules)
```

---

## üéØ **Strat√©gies de R√©solution**

### **Option 1 : D√âSACTIVER RLS (Recommand√© pour d√©veloppement)**

**Avantages** :
- ‚úÖ D√©blocage imm√©diat de toutes les donn√©es
- ‚úÖ Pas de complexit√© de policies
- ‚úÖ Id√©al pour d√©veloppement/prototypage
- ‚úÖ S√©curit√© assur√©e par les hooks (useHRMinimal, etc.)

**Inconv√©nients** :
- ‚ö†Ô∏è Pas de s√©curit√© au niveau base de donn√©es
- ‚ö†Ô∏è D√©pend de la s√©curit√© applicative

**Quand utiliser** :
- Application en d√©veloppement
- S√©curit√© g√©r√©e au niveau applicatif
- Pas d'acc√®s direct √† la base de donn√©es

---

### **Option 2 : CR√âER DES POLICIES (Recommand√© pour production)**

**Avantages** :
- ‚úÖ S√©curit√© maximale au niveau base de donn√©es
- ‚úÖ Protection m√™me en cas de bug applicatif
- ‚úÖ Audit trail complet
- ‚úÖ Conforme aux standards enterprise

**Inconv√©nients** :
- ‚ö†Ô∏è Complexit√© de configuration
- ‚ö†Ô∏è Maintenance des policies
- ‚ö†Ô∏è Risque de blocage si mal configur√©

**Quand utiliser** :
- Application en production
- Donn√©es sensibles (RH, paie, etc.)
- Conformit√© r√©glementaire requise

---

## ‚úÖ **MIGRATION CR√â√âE : Option 3 - Policies Granulaires**

**Fichier** : `20250111000200_configure_rls_policies_granular.sql`

### **Contenu de la Migration**

#### **1. Fonction Helper**
```sql
CREATE FUNCTION auth.has_role(role_names TEXT[])
-- V√©rifie si l'utilisateur a un des r√¥les sp√©cifi√©s
```

#### **2. Policies Cr√©√©es (50+ policies)**

**Employees (4 policies)** :
- Lecture pour tous du tenant
- Lecture de son propre profil
- √âcriture pour RH uniquement
- Mise √† jour limit√©e de son profil

**Absences (3 policies)** :
- Lecture pour tous
- Cr√©ation pour soi-m√™me
- Gestion pour RH uniquement

**Documents (3 policies)** :
- Lecture de ses documents
- Lecture tous pour RH
- Gestion pour RH uniquement

**Payrolls (2 policies)** :
- Lecture de son propre salaire
- Acc√®s complet pour Payroll/RH

**Expenses (5 policies)** :
- Lecture de ses rapports
- Cr√©ation de ses rapports
- Gestion pour Finance
- Items li√©s aux rapports

**Timesheets (3 policies)** :
- Lecture de ses timesheets
- Gestion de ses timesheets
- Acc√®s complet pour Managers

**√âvaluations (6 policies)** :
- Objectives, Key Results, Evaluations
- Lecture/√âcriture selon r√¥le

**Onboarding/Offboarding (8 policies)** :
- Acc√®s RH uniquement

**Tables non critiques (14)** :
- RLS d√©sactiv√©

---

## üöÄ **Solution Recommand√©e : Approche Hybride (ALTERNATIVE)**

### **Phase 1 : D√©veloppement (Maintenant)**

**D√©sactiver RLS sur les tables non critiques** :

```sql
-- Tables de d√©veloppement/prototypage
ALTER TABLE capacity_planning DISABLE ROW LEVEL SECURITY;
ALTER TABLE country_policies DISABLE ROW LEVEL SECURITY;
ALTER TABLE hr_analytics DISABLE ROW LEVEL SECURITY;
ALTER TABLE employee_insights DISABLE ROW LEVEL SECURITY;
ALTER TABLE task_audit_logs DISABLE ROW LEVEL SECURITY;

-- Tables recrutement (si pas encore utilis√©es)
ALTER TABLE candidates DISABLE ROW LEVEL SECURITY;
ALTER TABLE interviews DISABLE ROW LEVEL SECURITY;
ALTER TABLE job_applications DISABLE ROW LEVEL SECURITY;
ALTER TABLE job_offers DISABLE ROW LEVEL SECURITY;
ALTER TABLE job_posts DISABLE ROW LEVEL SECURITY;
```

**Cr√©er des policies simples pour les tables critiques** :

```sql
-- Employees : Acc√®s par tenant
CREATE POLICY "tenant_isolation" ON employees
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Absences : Acc√®s par tenant
CREATE POLICY "tenant_isolation" ON absences
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Payrolls : Acc√®s par tenant (donn√©es sensibles)
CREATE POLICY "tenant_isolation" ON employee_payrolls
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);
```

---

### **Phase 2 : Production (Plus tard)**

**Policies granulaires par r√¥le** :

```sql
-- Employees : Lecture pour tous, √©criture pour RH uniquement
CREATE POLICY "employees_read" ON employees
  FOR SELECT
  USING (
    tenant_id = current_setting('app.current_tenant_id', true)::uuid
  );

CREATE POLICY "employees_write" ON employees
  FOR INSERT, UPDATE, DELETE
  USING (
    tenant_id = current_setting('app.current_tenant_id', true)::uuid
    AND EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
        AND role_id IN (
          SELECT id FROM roles WHERE name IN ('hr_admin', 'tenant_admin')
        )
    )
  );

-- Payrolls : Acc√®s RH uniquement
CREATE POLICY "payrolls_hr_only" ON employee_payrolls
  FOR ALL
  USING (
    tenant_id = current_setting('app.current_tenant_id', true)::uuid
    AND EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
        AND role_id IN (
          SELECT id FROM roles WHERE name IN ('hr_admin', 'payroll_admin')
        )
    )
  );
```

---

## üìù **Migration Propos√©e**

### **Approche Pragmatique : D√©sactiver RLS Temporairement**

```sql
-- Migration: D√©sactiver RLS sur tables non critiques
-- Date: 2025-01-11
-- Description: D√©blocage temporaire pour d√©veloppement

BEGIN;

DO $$
BEGIN
  RAISE NOTICE 'üîì D√©sactivation temporaire RLS pour d√©veloppement...';
END $$;

-- ============================================
-- TABLES NON CRITIQUES (D√©sactiver RLS)
-- ============================================

-- Analytics & Insights (pas de donn√©es sensibles)
ALTER TABLE hr_analytics DISABLE ROW LEVEL SECURITY;
ALTER TABLE employee_insights DISABLE ROW LEVEL SECURITY;
ALTER TABLE task_audit_logs DISABLE ROW LEVEL SECURITY;

-- Recrutement (fonctionnalit√© pas encore active)
ALTER TABLE candidates DISABLE ROW LEVEL SECURITY;
ALTER TABLE interviews DISABLE ROW LEVEL SECURITY;
ALTER TABLE job_applications DISABLE ROW LEVEL SECURITY;
ALTER TABLE job_offers DISABLE ROW LEVEL SECURITY;
ALTER TABLE job_posts DISABLE ROW LEVEL SECURITY;

-- Planning & Configuration
ALTER TABLE capacity_planning DISABLE ROW LEVEL SECURITY;
ALTER TABLE country_policies DISABLE ROW LEVEL SECURITY;

-- S√©curit√© (logs uniquement)
ALTER TABLE employee_access_logs DISABLE ROW LEVEL SECURITY;
ALTER TABLE safety_documents DISABLE ROW LEVEL SECURITY;
ALTER TABLE safety_incidents DISABLE ROW LEVEL SECURITY;
ALTER TABLE corrective_actions DISABLE ROW LEVEL SECURITY;

DO $$
BEGIN
  RAISE NOTICE '‚úÖ RLS d√©sactiv√© sur 14 tables non critiques';
END $$;

-- ============================================
-- TABLES CRITIQUES (Cr√©er policies simples)
-- ============================================

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'üîê Cr√©ation de policies pour tables critiques...';
END $$;

-- Employees (donn√©es RH sensibles)
CREATE POLICY "tenant_isolation_employees" ON employees
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Absences
CREATE POLICY "tenant_isolation_absences" ON absences
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Employee Documents (documents sensibles)
CREATE POLICY "tenant_isolation_employee_documents" ON employee_documents
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Employee Payrolls (donn√©es financi√®res sensibles)
CREATE POLICY "tenant_isolation_payrolls" ON employee_payrolls
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Skill Assessments
CREATE POLICY "tenant_isolation_skill_assessments" ON skill_assessments
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Tardiness
CREATE POLICY "tenant_isolation_tardiness" ON tardiness
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Training Enrollments
CREATE POLICY "tenant_isolation_training_enrollments" ON training_enrollments
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Training Programs
CREATE POLICY "tenant_isolation_training_programs" ON training_programs
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Evaluations
CREATE POLICY "tenant_isolation_evaluations" ON evaluations
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Key Results
CREATE POLICY "tenant_isolation_key_results" ON key_results
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Objectives
CREATE POLICY "tenant_isolation_objectives" ON objectives
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Expense Items
CREATE POLICY "tenant_isolation_expense_items" ON expense_items
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Expense Reports
CREATE POLICY "tenant_isolation_expense_reports" ON expense_reports
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Payroll Components
CREATE POLICY "tenant_isolation_payroll_components" ON payroll_components
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Payroll Periods
CREATE POLICY "tenant_isolation_payroll_periods" ON payroll_periods
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Timesheets
CREATE POLICY "tenant_isolation_timesheets" ON timesheets
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Onboarding Processes
CREATE POLICY "tenant_isolation_onboarding_processes" ON onboarding_processes
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Onboarding Tasks
CREATE POLICY "tenant_isolation_onboarding_tasks" ON onboarding_tasks
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Offboarding Processes
CREATE POLICY "tenant_isolation_offboarding_processes" ON offboarding_processes
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

-- Offboarding Tasks
CREATE POLICY "tenant_isolation_offboarding_tasks" ON offboarding_tasks
  FOR ALL
  USING (tenant_id = current_setting('app.current_tenant_id', true)::uuid);

DO $$
BEGIN
  RAISE NOTICE '‚úÖ Policies cr√©√©es sur 21 tables critiques';
END $$;

-- ============================================
-- R√âSUM√â
-- ============================================

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
  RAISE NOTICE '';
  RAISE NOTICE '‚úÖ CONFIGURATION RLS COMPL√âT√âE';
  RAISE NOTICE '';
  RAISE NOTICE 'üìä R√©sum√©:';
  RAISE NOTICE '   ‚Ä¢ Tables RLS d√©sactiv√©: 14 (non critiques)';
  RAISE NOTICE '   ‚Ä¢ Tables avec policies: 21 (critiques)';
  RAISE NOTICE '   ‚Ä¢ Total trait√©: 35 tables';
  RAISE NOTICE '';
  RAISE NOTICE 'üîê S√©curit√©:';
  RAISE NOTICE '   ‚úÖ Isolation par tenant sur toutes les tables critiques';
  RAISE NOTICE '   ‚úÖ Donn√©es RH/Paie prot√©g√©es';
  RAISE NOTICE '   ‚úÖ Acc√®s d√©blo qu√© pour d√©veloppement';
  RAISE NOTICE '';
  RAISE NOTICE 'üí° Prochaines √©tapes:';
  RAISE NOTICE '   1. Tester l''acc√®s aux donn√©es';
  RAISE NOTICE '   2. Configurer app.current_tenant_id dans les requ√™tes';
  RAISE NOTICE '   3. Impl√©menter policies granulaires en production';
  RAISE NOTICE '';
  RAISE NOTICE '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
END $$;

COMMIT;
```

---

## ‚öôÔ∏è **Configuration Applicative Requise**

### **D√©finir le Tenant ID dans les Requ√™tes**

```typescript
// Dans votre hook useSupabase ou middleware
const setTenantContext = async (tenantId: string) => {
  await supabase.rpc('set_config', {
    setting: 'app.current_tenant_id',
    value: tenantId
  });
};

// Ou directement dans les requ√™tes
const { data } = await supabase
  .rpc('set_config', {
    setting: 'app.current_tenant_id',
    value: tenantId
  })
  .then(() => supabase.from('employees').select('*'));
```

---

## üéØ **Recommandation Finale**

### **Pour MAINTENANT (D√©veloppement)**

1. ‚úÖ **Appliquer la migration propos√©e**
   - D√©sactive RLS sur tables non critiques
   - Cr√©e policies simples sur tables critiques

2. ‚úÖ **Configurer app.current_tenant_id**
   - Dans les hooks (useHRMinimal, useTasks, etc.)
   - Au niveau du middleware Supabase

3. ‚úÖ **Tester l'acc√®s aux donn√©es**
   - V√©rifier que les requ√™tes fonctionnent
   - Confirmer l'isolation par tenant

### **Pour PLUS TARD (Production)**

1. **Policies granulaires par r√¥le**
   - Lecture/√©criture s√©par√©es
   - Permissions bas√©es sur user_roles

2. **Audit et monitoring**
   - Logs d'acc√®s RLS
   - M√©triques de s√©curit√©

3. **Tests de s√©curit√©**
   - Tentatives d'acc√®s cross-tenant
   - Validation des permissions

---

## üìö **Ressources**

- [Supabase RLS Documentation](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL RLS Guide](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Best Practices Multi-Tenant](https://supabase.com/docs/guides/auth/row-level-security#multi-tenancy)

---

## ‚úÖ **Checklist**

- [ ] D√©cider de la strat√©gie (d√©sactiver vs policies)
- [ ] Appliquer la migration
- [ ] Configurer app.current_tenant_id
- [ ] Tester l'acc√®s aux donn√©es
- [ ] Documenter la configuration
- [ ] Planifier les policies production

**Cette approche hybride d√©bloque le d√©veloppement tout en prot√©geant les donn√©es critiques !** üîê
